myP5JSの更新履歴
少しずつ変えていって
スマホ依存バグの原因を突き止める。

手始めにimageを2Dに特化させる

線のグラデーション導入しました
変化なしです
んー...

ここまでは大丈夫。あと2つですかね。
ベジエとクワドラは後回しでいい。先に面の方。これは変えるところが少ないので...
問題ないはずなんだけど...
テスト項目はまあ、もう知ってると思うけど、頂点色ライティング、ジオメトリの頂点色。とりあえずこの2つ。
というか自分で用意した6つ全部？あ、もうあるわ。これ全部試せばいいのね。

testおわりました～
pushおわりました。さて、どうなるか...
どうなるかなぁ

はい。消えました。やっぱね。
これが原因だ...
とはいえ...どうするかな。
スマホでしか起きてない以上、プログラム内のどこいじればいいのか、ねぇ。むずかしいよね。

ちぇ。
まあ、戻せばいいんだけど。
shaderかなぁ。でもshader戻すのかったるいな。一旦...uniformにしてみる？あるいは...
甘かった場所があるんだろう。

原因判明しました。スマホの方、頂点色でエラー出ますね。
頂点色実装後にエラーが出ました。パソコンでは出ません。
リリース前に直さないとえらいことになりますね...
パソコンでは出ないってのが厄介。やばいね。
imageの中のあそこをいじればいい、begin～endShapeの。ということは、おそらくあれのUVの...
メインの方はshader分岐はいじってないんですよ。あくまで、あの、フラグ渡してるだけで。フラグ？
単色か頂点色かってとこです。プリミティブが消えますよね。おそらく何かしらの影響で何かしらのフラグがオフになり、
その後trueにする機構が働かなくなる。そのあたりかと。

そうですね。uvが絡むbegin～endShapeが原因ですねぇ。これがあると、何らかの...
色が黒くなるなら背景のところにちゃんと黒いシルエットが映る、それが無いということは色の出力が無いのではなく...
たとえば？texture描画になっているがtextureが使えないので表示されない、とか？

そういうわけです。どうしようね。

透明度が0だと表示されないので透明度が0になってる可能性があります。
使われているのがphongShaderなのは間違いないです
そこで
一旦これを単色シェーダにします
今のスケッチの場合影響はないです。
これで様子を見ます。

なんなら真っ白とかでもいいんだけどね

ビンゴですね
なくなりました
というわけであそこなぜか知らないけどフラグが戻らず存在しないはずの頂点色が使われてしまっていますね
それで透明になってしまったようです
なぜ？スマホだけフラグが戻らず？しかもなぜimage関数内のbegin～endShapeが？関係してしまっているのか？？
なぜあそこをgeometryにするとうまくいくのか？geometryの描画にはRetainedが使われている。begin～endShapeはimmediateだ、で。
それがなぜプリミティブの描画に関係してくる？フラグの重複？レンダラーの...レンダラー？共通？？
すべてRetainedで揃うから、か？すべてあのフラグはfalse.
そして...immediateではあのフラグは常にtrueで...だよね。常にtrue. でもtextureがあればtextureが使われるのだ。そしてtextureが無い場合に
頂点色と単色の二択になるが、その際あのフラグが立っているとそっちが優先、しかしそれは、...計算されるからさぁ、...？？
shader取得前に計算されるべ？そこになんか入ってて、そのせいで、フラグが立ったまま...

えーーーーと。
あれ？
スマホ依存バグ...あれ？？

バグ出ました
というか、んー、？？

グラデーション正方形を追加したら
それ以外のプリミティブがすべて消滅しました
しかもimageを使っていないにもかかわらず、です。？？？
おそらく、まちがいなく、uUseVertexColorがtrueで描画されてるんですよ、ね。うん。...
違いますね
あそこがaVertexColorになる場合の見た目は灰色っぽいんですよ
とはいえあそこがuMaterialColorだと問題は生じない...となると原因はFragの方か？

isTextureがtrueであるがゆえにnullで...
となるとisTextureか？あれがなぜかtrueで...？
それも違う。そういう見た目じゃない。原因は...？？？消える？shaderが実行されていない？ドローコール自体が？

そういえばグラデーションのプリミティブは普通に描画されていますね

背景や文字を表示しないようにしてもだめでしたね。ん？

デフォルトをfalseにしました。それでもスマホだと、消えますね。はい。何なんだ...
パソコンでは相変わらずすべて描画されます。どのフラグを見ればいいんだ...

今スマホで調べたら最初のループでは4つ全部描画されますね。2ループ目以降で表示されてないです。
最初のループの後なんかあったみたいです。_updateでなんかいじる必要があるか？
まあこういうバグはよくあるんだけどね...おそらく迷路のあれも最初のループは表示されるのでしょう。んー...
つってもフラグ立てて普通に描画してるだけだが...？

あ、そうだ、なぜかplaneには影響ないんだよ。何で？？planeだけ影響ないんだよな...
はい。noLoopで最初のループだけにしたらtextureついたgeometryの描画の後boxが消滅してますね。だんだん輪郭が見えてきました。
つまりvertex colorの付いたなんかを描画すると（それがplaneであったとしても）そのあとの
なぜかplaneではなくboxとかtorusが消える、しかもスマホだけで。そういう謎の現象が起きているようです。

planeとboxたちの違いは何なのか、またなぜ頂点色の付いたgeometryを描画するとやばいのか。
begin～endでなんか描画するのも頂点色描画だから同じことだ。同じこと...スマホの最適化か？あれか？前にも遭遇したが...

つまりtexture云々はあまり関係なくて、...ということ？はい。そうです。textureは関係ないです。
というわけで、はっきりしてきました。まず、現象は頂点彩色のimmediateもしくはretainedを描画した直後に起こると。で、
考えが浅かったな...しかしドローコールは実行されているのだろうか？
planeに影響ないのも不可解。

頂点色の...消えないですね。
頂点色ならboxでも消えない...というかboxというかポリゴンですけど。
んー。んーー？？つまり、vertexColorsになんか入ってるやつをRetainedにせよImmediateにせよ一回でも描画すると、以降は
vertexColorsに何も入ってないやつらはすべてアウトになる...？？それはRetainedの...もしくはtextureもか。textureであそこがすっからかん。それもだめ。
そういうの以外、一切描画できなくなるみたい。Immediateは常にあそこなんか入ってるからね。...Immediateは常にそうなのよね...texture使う場合でも...
ていうかtextureはあれ、vColorを頂点色にしたうえでtextureのが採用されるのよ。

そうですね。単色描画しようとしてるやつらは軒並みアウトになってます。どゆこと。planeも？
planeも単色描画だけど描画されるべ。ああーーー！！

仮説は正しいようです。スマホだと、一回でもvertexColorsになんか入ってるものを描画すると、それ以降はvertexColorsがすっからかんの
オブジェクトはplaneを除いて一切描画されなくなります。なぜplaneだけ描画されるのか？？調査中です。
imageが悪いのではなくてその中で...ん？
あ、なるほど。
あのプログラム、「vertexColorsに何か入ってるやつが一切出てこない」んだ。平和な世界。それで全部滞りなく描画される。
つまり。
スマホ依存のバグ、未解決！！！何にも解決してなかった！

もし。
もし、vertexColorsに何も入ってない場合...単色かtextureの二択になるわけだが、
その場合仮にvertexColorsに単色がみっちり入っていたとしても
それって同じ結果になるわけですけど
それでもtextureがあればそっちが優先されるので問題ない
問題が生じているのは今のところ「RetainedModeのvertexColorsがすっからかんのジオメトリー」ですので。
だからあそこで「0の場合は単色で埋める」ってやれば問題ない？？どっち？Retainedだけ。
strokeでも同じ問題が生じてそうで怖い

というわけでdrawBuffersのdoFillのときの処理を

if (geometry.model.vertexColors.length > 0) {
  this._useVertexColor = true;
} else {
  this._useVertexColor = false;
  for (let i = 0; i < geometry.model.vertices.length; i++) {
    geometry.model.vertexColors.push(...this.curFillColor);
  }
}
// こうするの？？とりあえずこれで試してみる。
//this._useVertexColor = (geometry.model.vertexColors.length > 0);

こうしました。結果、意図的にvertexColorsの中身を空にしたgeometry以外はすべて描画されました。スマホでも。
たしかにうまくいったので何かが、何かが良かったようです。
しかしあれの場合は...

vertexColorsの中身が空のgeometryに対してはなぜかこの方法でもだめでした。なぜ？？？？

それと最終的にこの案は破棄しないといけない
なぜならvertexColorsに色を入れないということは、単色で彩色するということ。
つまりその「単色」が自由に変化させられるということ。
なので、固定できないんだよ。後で変えられなくなる。だからできない。

もっというと...まあいいんだけど。geometryの構成でvertexColors入れちゃうとその瞬間に
単色彩色が一切できなくなるのもほんとは駄目なんだよ。それもまずいわけ。ただ今の貧弱なシステムだと
そこら辺いじるのがとてつもなく難しいのよ。

うん、色の変化に対応できないので却下です。

0の場合は描画時だけcurFillColorで満たして、それが終わったら戻す、とか？でもmodelに影響ないの不自然だよね...スマホだけ影響ないとかマジで不可解

気になるのはこれがimmediateModeの頂点色描画でも生じるってことよ。

...

なんていうかもう、機種依存とかじゃなくて、ただのメモリ不足のような気がしてきた。
もう挙動がおかしいどころじゃないのよ。curFillColorはなぜか上書きされないし、表示されてたオブジェクトも消えるし、
セオリーが通用しない。もうめちゃくちゃ。めちゃくちゃなのよ。大体
プログラム通りに動かない時点で意味不明なのよ。だめだ、もう。

modelの場合、頂点色が入っててもだめみたいです。だからあの方策が通用しなかった...？？
いや、何か入ってる場合にあの方策を利用するとOKみたいです。どゆこと？

メモリ不足ではなく機種依存バグです。間違いなく。

Retainedの方のフラグを折ってみる。

フラグ折りましたが影響消えなかったです。falseにしてgeometryの方vertexColorsが反映されないようにしても
それ以降の単色プリミティブは見事に消えてしまいました。何で？しかもスマホ限定で。はぁ？？？

ImmediateとRetainedは同じshaderを使っている。Immediateではフラグへの代入はendShapeでしかやっていない。
同じshaderを使ってるせいで問題が生じている？違う。だって今回immediateは不使用。となると...
仕様変更でphongVertの方、vColorをuMaterialColorにしたら問題が消えた（もちろん頂点色も消えた）
あれで問題が消えるの冷静に考えたらおかしい
おかしいんだよ。
いっそaVertexColor限定にする？か？

もしくは

頂点色＆ライティングの場合だけ違うshaderを使う...？フラグで分岐させるのではなくshader自体違うものにしてしまえばいい？

とりあえず再びuMaterialColorにして様子を見る...

verexColorPhongVert
vertexColorPhongFrag
あと2種についても同様に

shaderいじったら単色プリミティブすべてOKになったんですけど
あっちの方はmodelが変なことになってますね

あれtextureのbox以外全部phongVert--phongFragで描いてるからすべてに影響が出てるんですけど
まずいみたいですね

というわけでもう一度、今度はフラグも折ってみるか
もうひとつ
phongVertからuniform bool uUseVertexC

bool？？？
そういえばboolまずいんだっけか
・・・
uniform bool uUseVertexColor外してみる
今使ってないし
boolはあれ、まずいのは配列だったと思う。確か。
これで様子を見る...

だめですね。
setUniformもなくすか。それでまた様子を見る。
しばらく待って反映されないようならimmediateの方のフラグもfalse...ってもう影響してないんでしょ
全部phongVertで描画してるんだから
どこいじればいいのよ
ていうか
もともと問題発生してたってこと？？
それともvertexColorsになんか入れる行為自体がもうなんか、タブーというか、そういうこと？？

aVertexColorも排除して。宣言がどう影響するのかしらないけど、なにかしら、あると思うので。
というかもうそこしかいじれないのよ。これいじったらもう、少なくともphongしか使わないなら、以前と一緒になってしまう。
それとも以前からあった問題なのか？それとも...
lineと同じ変数名なのがやばいのか？？？？それはあるかもしれない...？？shader違うのにそうなのか？？？？
いやlineつかってないやろ
一旦前の状態に戻します。もうわからん。
大丈夫。fill関連のshaderまとめて戻すだけだから。？
そういえばvertexStrokeColorとvertexColorがどちらも同じ名前のaVertexColorって変数に紐付けられてるわね...これまずいのでは？
lineの方でaVertexColor使ったのやっぱまずかったか...？aVertexStrokeColorに改名すべきかもしれない。それか？
あれはこっちもなんかやばいなって思ってたんだよな
でも...
スマホ限定のバグがそんな簡単に直るもんなのか？

aVertexColorだめ
はい
戻しましょう

全部戻したよ。
単色描画はできるようになったしおそらくimageもできる、できるんだけど、
modelの方、1つまでしか描画されないですね。
どうしますか？

線のグラデーションは改変箇所多すぎて対処の仕様が...ていうか
線でしょ？関係ある？？
それ以前のあれこれはshaderいじってないからおそらく無関係なのよ。
だから可能性としてはさ
う～ん
だってfillなのにstroke関連の仕様変更がどうして影響するのよ

fillなのにstrokeの仕様変更が影響するの？
これだけ時間たったら反映されるだろ
はい。strokeの仕様変更の時点で問題は起きてましたね。どういうこと？

線のグラデで問題起きてるなら全部やり直すしかないわね

あのですね
1.5.0でもだめですね。？？？
黒背景だと黒いときに消えちゃうので灰色がいいですよ

黒いだけで見えてた
ということです

4.2→5.0のときlightingの仕方に変更があってそれで真っ黒が真っ黒でなくなった
あれたしかambient辺り？それでこうなったっぽいね。
んー
1.5.0にも問題があったの...か？

1.5.0の状態でも2つ目以降のmodel消失確認できました
スマホだけです
パソコンは影響なし
つまりこのバグはもともと存在していたのよ
こっちの独自仕様変更とは別に存在していたということ
それが
ああでもshaderでuUseVertexColor使って処理分岐させるのやめたら単色に関しては復活したんだよな
でも1.5.0に起因するバグは解消されなかったわけだ。
つまり
model消失とstroke gradationはおそらく無関係で
----
単色消失バグがvertexColor gradationによる影響で
model消失バグが1.5.0に起因するもの、
----
という認識でよさそう

どうしろと？？
だから線のグラデーションを諦めてもmodel消失バグは消えないのよ
もう検証済みだけど
